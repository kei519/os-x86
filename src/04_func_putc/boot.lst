     1                                  	BOOT_LOAD	equ	0x7C00		; ブートプログラムのロード位置
     2                                  
     3                                  	ORG	BOOT_LOAD
     4                                  
     5                                  ; マクロ
     6                                  %include	"../include/macro.s"
     1                              <1> %macro	cdecl 1-*.nolist
     2                              <1> 	%rep	%0 - 1
     3                              <1> 		push	%{-1:-1}
     4                              <1> 		%rotate	-1
     5                              <1> 	%endrep
     6                              <1> 	%rotate	-1
     7                              <1> 	call	%1
     8                              <1> 	add	sp, (__BITS__ >> 3) * (%0 - 1)
     9                              <1> %endmacro
     7                                  
     8                                  ; エントリポイント
     9                                  entry:
    10 00000000 EB58                    	jmp	ipl
    11                                  
    12                                  	;BPM (Boot Parameter Block)
    13 00000002 90<rept>                	times	90 - ($ - $$) db 0x90
    14                                  
    15                                  	;IPL (Initial Program Loader)
    16                                  
    17                                  ipl:
    18 0000005A FA                      	cli					; 割り込み禁止
    19                                  
    20 0000005B B80000                  	mov	ax, 0
    21 0000005E 8ED8                    	mov	ds, ax
    22 00000060 8EC0                    	mov	es, ax
    23 00000062 8ED0                    	mov	ss, ax
    24 00000064 BC007C                  	mov	sp, BOOT_LOAD
    25                                  
    26 00000067 FB                      	sti					; 割り込み許可
    27                                  
    28 00000068 8816[A600]              	mov	[BOOT.DRIVE], dl
    29                                  
    30                                  	; 自分で呼び出して文字を表示
    31 0000006C 6A41                    	push	word 'A'
    32 0000006E E83700                  	call	putc
    33 00000071 83C402                  	add	sp, 2
    34                                  
    35 00000074 6A42                    	push	word 'B'
    36 00000076 E82F00                  	call	putc
    37 00000079 83C402                  	add	sp, 2
    38                                  
    39 0000007C 6A43                    	push	word 'C'
    40 0000007E E82700                  	call	putc
    41 00000081 83C402                  	add	sp, 2
    42                                  
    43                                  	; マクロで文字表示
    44 00000084 6A5A6A596A586A4A6A-     	cdecl	putc, word 'X', word 'J', word 'X', word 'Y', word'Z'
    44 0000008D 58E8170083C40A     
    45 00000094 6A59E80F0083C402        	cdecl	putc, word 'Y'
    46 0000009C 6A5AE8070083C402        	cdecl	putc, word 'Z'
    47                                  
    48 000000A4 EBFE                    	jmp	$	; 無限ループ
    49                                  
    50                                  ALIGN 2, db 0
    51                                  BOOT:						; ブートドライブに関する情報
    52 000000A6 0000                    .DRIVE		dw 0				; ドライブ番号
    53                                  
    54                                  ; モジュール
    55                                  %include	"../modules/real/putc.s"
     1                              <1> putc:
     2                              <1> 	; スタックフレームの構築
     3 000000A8 55                  <1> 	push	bp
     4 000000A9 89E5                <1> 	mov	bp, sp
     5                              <1> 
     6                              <1> 	; レジスタの保存
     7 000000AB 50                  <1> 	push	ax
     8 000000AC 53                  <1> 	push	bx
     9                              <1> 
    10                              <1> 	; 処理の開始
    11 000000AD 8A4604              <1> 	mov	al, [bp + 4]		; 文字コードの取得
    12 000000B0 B40E                <1> 	mov	ah, 0x0E		; テレタイプ式1文字出力
    13 000000B2 BB0000              <1> 	mov	bx, 0			; ページ番号と文字色を0に設定
    14 000000B5 CD10                <1> 	int	0x10			; ビデオBIOSコール
    15                              <1> 
    16                              <1> 	; レジスタの復帰
    17 000000B7 5B                  <1> 	pop	bx
    18 000000B8 58                  <1> 	pop	ax
    19                              <1> 
    20                              <1> 	; スタックフレームの破壊
    21 000000B9 89EC                <1> 	mov	sp, bp
    22 000000BB 5D                  <1> 	pop	bp
    23                              <1> 
    24 000000BC C3                  <1> 	ret
    56                                  
    57                                  ; ブートフラグ
    58 000000BD 00<rept>                	times 510 - ($ - $$) db 0x00
    59 000001FE 55AA                    	db 0x55, 0xAA
